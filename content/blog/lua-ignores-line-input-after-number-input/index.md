---
title: Luaの標準入力で数値入力した直後の行入力が実行されない
date: "2020-06-18T00:36:20.579+09:00"
description: Luaの標準入力で、数値入力した直後に追加の行入力があると、行入力がスキップされる。これは行入力が、数値入力のストリームを終了させるために流用されているため。
---

[Neovim](https://neovim.io)が[Lua](http://www.lua.org)のランタイムを最初から同梱していることを知ったので、最近Luaを学んでいます。[Hammerspoon](http://www.hammerspoon.org)とかも、設定をLuaで書くんですよね。

プラグインのように、プロダクト本体を拡張するための小規模なコードをカジュアルに書きたい、でも速度は犠牲にしたくないという、物事の隅っこに棲息する需要は必ず発生します。Luaは、そういった用途に割り切った言語でないかと思います。

練習がてら[AtCoder](https://atcoder.jp)の簡単な例題を解いていました。AtCoderはプログラミングコンテストを開催するサービスです。問題文に記載のある指定された形式のデータを標準入力から与え、加工した結果を標準出力に流します。出力結果が合っていれば正解となります。

ということで、Luaでの入出力の書き方にいきなり直面する訳ですが、[最初の問題](https://atcoder.jp/contests/abs/tasks/practice_1)ではまってしまいました。

この問題では3行の入力が与えられます。1行目は整数1個ですが、2行目はスペースを挟んで整数2個です。3行目は文字列が入力されます。

```
1
2 3
test
```

出力は上の例で言うと、 `1` と `2` と `3` を足した結果と `test` を、スペースを挟んで出力します。

```
6 test
```

そこで以下のコードを書きました。

```lua
#!/usr/bin/env lua

local a, b, c = io.read('n', 'n', 'n')
local s = io.read('l')
print(a + b + c .. ' ' .. s)
```

`io.read()` の引数を `'n', 'n', 'n'` とすることで、数値を3つ変数に取り込んでくれます。

1行に数値が3つあっても構いません。

```
1 2 3
```

1行に1つずつでも構いません。

```
1
2
3
```

間に空行を挟んでも問題ありません。

```
1



2 3
```

ここまでは柔軟性があり便利なように思えます。

また、 `io.read('l')` で行全体を受け取ってくれます。

権限を与えて実行します。すると以下の結果になります。

```bash
$ chmod u+x ./practice_1.lua
$ ./practice_1.lua
1
2 3
6
```

`2 3` と入力して `return` を押した時点で `6` が返ります。 `test` を入力するタイミングがありませんでした。

奇妙な挙動で手こずりましたが、何とか[情報](https://stackoverflow.com/questions/14343502/io-read-isnt-working/14344237#14344237)を見つけることができました。

先ほど述べましたが、数値っぽいものが3つ見つかるまでは、ユーザーは標準入力で空行を何行入力しても構いません。裏を返すと `io.read('n')` にとって、改行には特別な意味がないということになります。

数値入力の流れを明示的に断ち切るためにLuaが `io.read('l')` を1つ消費しているようです。本来は文字入力をするための記述が、数値入力に奪われるため、文字入力のための待ち受けが生じなかったということになります。この問題を[回避](https://atcoder.jp/contests/abs/submissions/12169717)するには、次のように末尾の `'n'` の後ろに `'l'` を置きます。

```lua
#!/usr/bin/env lua

local a, b, c = io.read('n', 'n', 'n', 'l')
local s = io.read('l')
print(a + b + c .. ' ' .. s)
```

釈然としない仕様ですが、これで意図した通りに動くようになりました。
